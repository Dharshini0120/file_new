import React, { useState, useEffect, useRef } from 'react';
import { Handle, Position } from 'reactflow';
import { Box, IconButton, Tooltip } from '@mui/material';
import EditIcon from '@mui/icons-material/Edit';
import DeleteIcon from '@mui/icons-material/Delete';
import EditQuestionModal from './TemplateEditQuestionModal';

interface OptionData {
    text: string;
    score?: number | string;
    referralText?: string; // Custom referral text instead of predefined types
}

interface QuestionNodeData {
    question: string;
    questionType: 'text-input' | 'multiple-choice' | 'radio' | 'checkbox' | 'yes-no' | 'select';
    options: string[];
    optionsData?: OptionData[]; // Enhanced option data
    isRequired: boolean;
    onUpdate: (id: string, newData: any) => void;
    onDelete: (id: string) => void;
    onUpdateEdgeLabels?: (nodeId: string, newOptions: string[]) => void;
}

interface QuestionNodeProps {
    data: QuestionNodeData;
    id: string;
    selected?: boolean;
    highlighted?: boolean; // Add highlighted prop
}

const QuestionnaireNode: React.FC<QuestionNodeProps> = ({ data, id, selected = false, highlighted = false }) => {
    const [showEditModal, setShowEditModal] = useState(!data.question);
    const [nodePosition, setNodePosition] = useState({ x: 0, y: 0 });
    const nodeRef = useRef<HTMLDivElement>(null);
    const { question, questionType, options, optionsData, isRequired } = data;

    // Get node position for modal placement
    useEffect(() => {
        if (nodeRef.current && showEditModal) {
            const rect = nodeRef.current.getBoundingClientRect();
            const reactFlowBounds = document.querySelector('.react-flow')?.getBoundingClientRect();

            if (reactFlowBounds) {
                setNodePosition({
                    x: rect.right - reactFlowBounds.left + 30, // Consistent 30px gap from right edge
                    y: rect.top - reactFlowBounds.top - 10 // Consistent 10px above the node
                });
            }
        }
    }, [showEditModal]);

    const getQuestionTypeLabel = () => {
        switch (questionType) {
            case 'text-input': return 'TEXT INPUT';
            case 'multiple-choice': return 'MULTIPLE CHOICE';
            case 'radio': return 'RADIO';
            case 'checkbox': return 'CHECKBOX';
            case 'yes-no': return 'YES/NO';
            case 'select': return 'SELECT';
            default: return 'QUESTION';
        }
    };

    const handleSave = (newData: any) => {
        console.log('üíæ QuestionnaireNode received save data:', newData);
        
        // Check if required functions exist
        if (!data.onUpdate) {
            console.error('‚ùå QuestionnaireNode: onUpdate function is missing!');
            console.error('‚ùå Available data keys:', Object.keys(data));
            console.error('‚ùå Data object:', data);
            alert('Error: Cannot save question. Please refresh the page and try again.');
            return;
        }
        
        // No need to preserve old options - use the new ones from the modal
        
        const dataToSave = {
            ...newData,
            // Use the new options from the modal
            options: newData.options || [],
            // Ensure optionsData is properly set
            optionsData: newData.optionsData || []
        };

        console.log('üíæ Saving data to node:', dataToSave);
        console.log('üíæ Options to save:', dataToSave.options);
        console.log('üíæ OptionsData to save:', dataToSave.optionsData);

        // Update the node data first
        data.onUpdate(id, dataToSave);

        // Update connected edge labels if options changed
        if (dataToSave.options && data.onUpdateEdgeLabels) {
            data.onUpdateEdgeLabels(id, dataToSave.options);
        }

        setShowEditModal(false);
    };


    const handleDelete = () => {
        if (!data.onDelete) {
            console.error('‚ùå QuestionnaireNode: onDelete function is missing!');
            console.error('‚ùå Available data keys:', Object.keys(data));
            alert('Error: Cannot delete question. Please refresh the page and try again.');
            return;
        }
        data.onDelete(id);
    };

    const handleEdit = () => {
        setShowEditModal(true);
    };

    const updateConnectedEdgeLabels = (nodeId: string, newOptions: string[]) => {
        // This function should be passed from the parent component
        if (data.onUpdateEdgeLabels) {
            data.onUpdateEdgeLabels(nodeId, newOptions);
        }
    };

    // Debug logging for options
    console.log('üîç QuestionnaireNode render - questionType:', questionType);
    console.log('üîç QuestionnaireNode render - options:', options);
    console.log('üîç QuestionnaireNode render - optionsData:', optionsData);
    console.log('üîç QuestionnaireNode render - question:', question);

    return (
        <>
            <Box
                ref={nodeRef}
                sx={{
                    background: '#f0f2f3',
                    border: highlighted ? '3px solid #ff9800' : '2px solid #4baaf4',
                    borderRadius: '12px',
                    minWidth: '280px',
                    maxWidth: '350px',
                    boxShadow: highlighted ? '0 8px 24px rgba(255, 152, 0, 0.3)' : '0 4px 12px rgba(0,0,0,0.1)',
                    overflow: 'visible',
                    position: 'relative',
                    transform: highlighted ? 'scale(1.02)' : 'scale(1)',
                    transition: 'all 0.3s ease',
                    zIndex: highlighted ? 10 : 1
                }}
            >
                {/* Input Handle */}
                <Handle
                    type="target"
                    position={Position.Top}
                    style={{
                        background: '#4baaf4',
                        width: '12px',
                        height: '12px',
                        border: '2px solid white',
                        borderRadius: '50%',
                        top: '-18px',
                        zIndex: 100,
                        boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                    }}
                />

                {/* Header */}
                <Box sx={{
                    background: '#4baaf4',
                    color: 'white',
                    padding: '12px 15px',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    borderRadius: '10px 10px 0 0',
                    position: 'relative'
                }}>
                    <Box sx={{
                        fontSize: '12px',
                        fontWeight: '700',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px'
                    }}>
                        {getQuestionTypeLabel()}
                        {isRequired && <span style={{ color: '#ff4444', marginLeft: '4px', fontWeight: 'bold' }}>*</span>}
                    </Box>
                    <Box sx={{ display: 'flex', gap: '4px' }}>
                        <IconButton
                            size="small"
                            onClick={handleEdit}
                            sx={{
                                color: 'white',
                                background: 'rgba(255,255,255,0.2)',
                                width: '24px',
                                height: '24px',
                                '&:hover': { background: 'rgba(255,255,255,0.3)' }
                            }}
                        >
                            <EditIcon sx={{ fontSize: '14px' }} />
                        </IconButton>
                        <IconButton
                            size="small"
                            onClick={handleDelete}
                            sx={{
                                color: 'white',
                                background: 'rgba(255,255,255,0.2)',
                                width: '24px',
                                height: '24px',
                                '&:hover': { background: 'rgba(255,255,255,0.3)' }
                            }}
                        >
                            <DeleteIcon sx={{ fontSize: '14px' }} />
                        </IconButton>
                    </Box>
                </Box>

                {/* Content */}
                <Box sx={{ padding: '15px' }}>
                    <Box sx={{
                        fontSize: '16px',
                        fontWeight: '600',
                        color: '#4baaf4',
                        marginBottom: '8px',
                        lineHeight: '1.3'
                    }}>
                        {question || 'Untitled Question'}
                    </Box>

                                    {/* Show options for applicable question types */}
                {['multiple-choice', 'checkbox', 'radio', 'select'].includes(questionType) && options && (
                    <Box sx={{ fontSize: '13px', color: '#666' }}>
                        <Box sx={{ fontWeight: '600', marginBottom: '4px' }}>Options:</Box>
                        <Box component="ul" sx={{ margin: '0', paddingLeft: '15px' }}>
                            {options.map((option, index) => {
                                const optionData = optionsData?.[index];
                                console.log(`üîç Rendering option ${index}:`, option, 'with data:', optionData);
                                return (
                                    <Box component="li" key={index} sx={{ marginBottom: '2px', fontWeight: '500' }}>
                                        {option}
                                        {optionData?.score !== undefined && optionData.score !== '' && (
                                            <span style={{ color: '#059669', fontSize: '11px', marginLeft: '8px' }}>
                                                (Score: {optionData.score})
                                            </span>
                                        )}
                                    </Box>
                                );
                            })}
                        </Box>
                    </Box>
                )}

                    {questionType === 'yes-no' && (
                        <Box sx={{ fontSize: '13px', color: '#666' }}>
                            <Box sx={{ fontWeight: '600' }}>Yes / No options</Box>
                        </Box>
                    )}

                    {questionType === 'text-input' && (
                        <Box sx={{ fontSize: '13px', color: '#666' }}>
                            <Box sx={{ fontWeight: '600' }}>Text input field</Box>
                        </Box>
                    )}
                </Box>

                {/* Output Handles */}
                {questionType === 'text-input' && (
                    <Tooltip
                        title={(optionsData?.[0]?.referralText && optionsData[0].referralText.trim() !== '') ? `Referral: ${optionsData[0].referralText}` : ''}
                        placement="top"
                        arrow
                        PopperProps={{
                            modifiers: [
                                {
                                    name: 'offset',
                                    options: {
                                        offset: [0, 8],
                                    },
                                },
                            ],
                        }}
                    >
                        <Box
                            sx={{
                                position: 'absolute',
                                right: '-6px',
                                top: '85px',
                                width: '12px',
                                height: '12px',
                                zIndex: 101,
                                cursor: (optionsData?.[0]?.referralText && optionsData[0].referralText.trim() !== '') ? 'not-allowed' : 'crosshair'
                            }}
                        >
                    <Handle
                        type="source"
                        position={Position.Right}
                        id="text-output"
                                isConnectable={!(optionsData?.[0]?.referralText && optionsData[0].referralText.trim() !== '')}
                        style={{
                                    background: (optionsData?.[0]?.referralText && optionsData[0].referralText.trim() !== '') ? '#000000' : '#4baaf4',
                            width: '12px',
                            height: '12px',
                            border: '2px solid white',
                            borderRadius: '50%',
                                    right: '0px',
                                    top: '0px',
                            zIndex: 100,
                            boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                        }}
                    />
                        </Box>
                    </Tooltip>
                )}

                {questionType === 'yes-no' && (
                    <>
                        <Tooltip
                            title={(optionsData?.[0]?.referralText && optionsData[0].referralText.trim() !== '') ? `Referral: ${optionsData[0].referralText}` : ''}
                            placement="top"
                            arrow
                            PopperProps={{
                                modifiers: [
                                    {
                                        name: 'offset',
                                        options: {
                                            offset: [0, 8],
                                        },
                                    },
                                ],
                            }}
                        >
                            <Box
                                sx={{
                                    position: 'absolute',
                                    right: '-6px',
                                    top: '85px',
                                    width: '12px',
                                    height: '12px',
                                    zIndex: 101,
                                    cursor: (optionsData?.[0]?.referralText && optionsData[0].referralText.trim() !== '') ? 'not-allowed' : 'crosshair'
                                }}
                            >
                        <Handle
                            type="source"
                            position={Position.Right}
                            id="yes"
                                    isConnectable={!(optionsData?.[0]?.referralText && optionsData[0].referralText.trim() !== '')}
                            style={{
                                        background: (optionsData?.[0]?.referralText && optionsData[0].referralText.trim() !== '') ? '#000000' : '#4baaf4',
                                width: '12px',
                                height: '12px',
                                border: '2px solid white',
                                borderRadius: '50%',
                                        right: '0px',
                                        top: '0px',
                                zIndex: 100,
                                boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                            }}
                        />
                            </Box>
                        </Tooltip>
                        <Tooltip
                            title={(optionsData?.[1]?.referralText && optionsData[1].referralText.trim() !== '') ? `Referral: ${optionsData[1].referralText}` : ''}
                            placement="top"
                            arrow
                            PopperProps={{
                                modifiers: [
                                    {
                                        name: 'offset',
                                        options: {
                                            offset: [0, 8],
                                        },
                                    },
                                ],
                            }}
                        >
                            <Box
                                sx={{
                                    position: 'absolute',
                                    right: '-6px',
                                    top: '105px',
                                    width: '12px',
                                    height: '12px',
                                    zIndex: 101,
                                    cursor: (optionsData?.[1]?.referralText && optionsData[1].referralText.trim() !== '') ? 'not-allowed' : 'crosshair'
                                }}
                            >
                        <Handle
                            type="source"
                            position={Position.Right}
                            id="no"
                                    isConnectable={!(optionsData?.[1]?.referralText && optionsData[1].referralText.trim() !== '')}
                            style={{
                                        background: (optionsData?.[1]?.referralText && optionsData[1].referralText.trim() !== '') ? '#000000' : '#4baaf4',
                                width: '12px',
                                height: '12px',
                                border: '2px solid white',
                                borderRadius: '50%',
                                        right: '0px',
                                        top: '0px',
                                zIndex: 100,
                                boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                            }}
                        />
                            </Box>
                        </Tooltip>
                    </>
                )}

                {/* Individual option handles for multiple-choice, radio, and select */}
                {['multiple-choice', 'radio', 'select'].includes(questionType) && options &&
                    options.map((option, index) => {
                        const optionData = optionsData?.[index];
                        const hasReferralText = optionData?.referralText && optionData.referralText.trim() !== '';
                        
                        return (
                            <Tooltip
                                key={`tooltip-option-${index}`}
                                title={hasReferralText ? `Referral: ${optionData.referralText}` : ''}
                                placement="top"
                                arrow
                                PopperProps={{
                                    modifiers: [
                                        {
                                            name: 'offset',
                                            options: {
                                                offset: [0, 8],
                                            },
                                        },
                                    ],
                                }}
                            >
                                <Box
                                    sx={{
                                        position: 'absolute',
                                        right: '-6px',
                                        top: `${85 + (index * 20)}px`,
                                        width: '12px',
                                        height: '12px',
                                        zIndex: 101,
                                        cursor: hasReferralText ? 'not-allowed' : 'crosshair'
                                    }}
                                >
                        <Handle
                            type="source"
                            position={Position.Right}
                            id={`option-${index}`}
                                        isConnectable={!hasReferralText}
                            style={{
                                            background: hasReferralText ? '#000000' : '#4baaf4',
                                width: '12px',
                                height: '12px',
                                border: '2px solid white',
                                borderRadius: '50%',
                                            right: '0px',
                                            top: '0px',
                                zIndex: 100,
                                boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                            }}
                        />
                                </Box>
                            </Tooltip>
                        );
                    })
                }

                {/* Checkbox handles - individual options + All Selected */}
                {questionType === 'checkbox' && options && (
                    <>
                        {/* Individual option handles */}
                        {options.map((option, index) => {
                            const optionData = optionsData?.[index];
                            const hasReferralText = optionData?.referralText && optionData.referralText.trim() !== '';
                            
                            return (
                                <Tooltip
                                    key={`tooltip-checkbox-option-${index}`}
                                    title={hasReferralText ? `Referral: ${optionData.referralText}` : ''}
                                    placement="top"
                                    arrow
                                    PopperProps={{
                                        modifiers: [
                                            {
                                                name: 'offset',
                                                options: {
                                                    offset: [0, 8],
                                                },
                                            },
                                        ],
                                    }}
                                >
                                    <Box
                                        sx={{
                                            position: 'absolute',
                                            right: '-6px',
                                            top: `${85 + (index * 18)}px`,
                                            width: '12px',
                                            height: '12px',
                                            zIndex: 101,
                                            cursor: hasReferralText ? 'not-allowed' : 'crosshair'
                                        }}
                                    >
                            <Handle
                                key={`option-${index}`}
                                type="source"
                                position={Position.Right}
                                id={`option-${index}`}
                                            isConnectable={!hasReferralText}
                                style={{
                                                background: hasReferralText ? '#000000' : '#4baaf4',
                                    width: '12px',
                                    height: '12px',
                                    border: '2px solid white',
                                    borderRadius: '50%',
                                                right: '0px',
                                                top: '0px',
                                    zIndex: 100,
                                    boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                                }}
                            />
                                    </Box>
                                </Tooltip>
                            );
                        })}

                        {/* All Selected handle */}
                        {options.length >= 2 && (
                            <Handle
                                type="source"
                                position={Position.Right}
                                id="multi-all"
                                style={{
                                    background: '#4caf50',
                                    width: '14px',
                                    height: '14px',
                                    border: '2px solid white',
                                    borderRadius: '50%',
                                    right: '-7px',
                                    top: `${85 + options.length * 18 + 10}px`,
                                    zIndex: 100,
                                    boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                                }}
                            />
                        )}
                    </>
                )}
            </Box>

            {/* Edit Modal positioned relative to node */}
            {showEditModal && (() => {
                // Ensure we pass valid option data to the modal with proper score binding
                let finalOptions;
                
                console.log('üîç QuestionnaireNode opening modal with:');
                console.log('üîç options:', options);
                console.log('üîç optionsData:', optionsData);
                
                // Always reconstruct from the current options array to ensure we have the latest text
                // while preserving scores and referral text from optionsData
                finalOptions = options.map((opt: any, index) => {
                    if (typeof opt === 'string') {
                        // Use the current option text from options array
                        const currentOptionText = opt;
                        // Find corresponding score and referral text from optionsData if available
                        const scoreData = optionsData && optionsData[index];
                        const result = { 
                            text: currentOptionText, 
                            score: scoreData?.score || undefined, 
                            referralText: scoreData?.referralText || '' 
                        };
                        console.log(`üîç Option ${index}: text="${currentOptionText}", score="${scoreData?.score}", referralText="${scoreData?.referralText}"`);
                        return result;
                    } else if (typeof opt === 'object' && opt !== null) {
                        // Option is already an object, preserve score and referralText
                        const result = {
                            text: opt.text || `Option ${index + 1}`,
                            score: opt.score || undefined,
                            referralText: opt.referralText || ''
                        };
                        console.log(`üîç Object option ${index}:`, result);
                        return result;
                    }
                    const result = { text: `Option ${index + 1}`, score: undefined, referralText: '' };
                    console.log(`üîç Fallback option ${index}:`, result);
                    return result;
                });

                console.log('üöÄ QuestionnaireNode passing finalOptions to modal:', finalOptions);
                console.log('üöÄ Final options details:', finalOptions.map((opt, idx) => ({
                    index: idx,
                    text: opt.text,
                    score: opt.score,
                    referralText: opt.referralText
                })));

                // Log the exact data being passed to the modal
                const modalData = {
                    question,
                    questionType,
                    options: finalOptions,
                    isRequired
                };
                console.log('üöÄ Modal data being passed:', modalData);
                console.log('üöÄ Modal options array:', modalData.options);
                console.log('üöÄ Modal options[0].text:', modalData.options[0]?.text);
                console.log('üöÄ Modal options[1].text:', modalData.options[1]?.text);

                return (
                    <EditQuestionModal
                        questionData={modalData}
                        onSave={handleSave}
                        onCancel={() => setShowEditModal(false)}
                        isNewQuestion={false}
                        nodePosition={nodePosition}
                    />
                );
            })()}
        </>
    );
};

export default QuestionnaireNode;